name: cmdx-ci

on:
  push:
    branches: [ master ]

  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  maya:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    strategy:
      matrix:
        maya2015:
          containerImage: mottosso/maya:2015sp6
        maya2016:
          containerImage: mottosso/maya:2016sp1
        maya2017:
          containerImage: mottosso/maya:2017
        maya2018:
          containerImage: mottosso/maya:2018
        maya2019:
          containerImage: mottosso/maya:2019
        maya2020:
          containerImage: mottosso/maya:2020
    container: $[ variables['containerImage'] ]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - run: |
          wget https://bootstrap.pypa.io/2.7/get-pip.py
          mayapy get-pip.py --user
          mayapy -m pip install --user \
            nose \
            nose-exclude \
            coverage \
            flaky \
            sphinx \
            sphinxcontrib-napoleon
        displayName: "pip install"

        # Since 2019, this sucker throws an unnecessary warning if not declared
      - run: |
          export XDG_RUNTIME_DIR=/var/tmp/runtime-root
        displayName: "Environment"

      - run: |
          mayapy --version
          mayapy run_tests.py
        displayName: "Unittests"

      - run: |
          mayapy build_livedocs.py && mayapy test_docs.py
        displayName: "Test docs"

      - run: |
          mayapy build_docs.py
        displayName: "Build docs"

      - publish: $(System.DefaultWorkingDirectory)/build/html
        artifact: docs
        condition: and(succeeded(), eq(variables['containerImage'], 'mottosso/maya:2020'))
